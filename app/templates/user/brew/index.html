<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include href="../../_incl/taglib.html"/>

<head>
  <title>brew of "${brew.recipe.name}" | brew-journal</title>
  <xi:include href="../../_incl/head.html"/>
  <script type="application/javascript">
    $(document).ready(function(){
      $('#first-focused').focus();
    });
  </script>
</head>
<body>
    <div id="doc3">
        <xi:include href="../../_incl/body-top-bar.html"/>

        <div id="bd">
            <div id="yui-main">
                <div class="yui-b">

  <h1 py:if="brew.recipe">brew of "${brew.recipe.name}"</h1>
  <h1 py:if="not brew.recipe">un-named brew</h1>

  <div id="details">
      <div>
          <span py:if="brew.brew_date">brewed on ${std.fmt.date.ymdhm(brew.brew_date, user)} </span>
          by <a href="/user/${brew.brewer.username}/">${brew.brewer.username}</a>
          <span py:if="brew.recipe">from recipe ${recipe_a(brew.recipe)}</span>
      </div>
      <div py:if="brew.recipe" class="recipe-style-summary" style="margin-top: 0.5em">
          <py:if test="brew.recipe.batch_size">
              ${brew.recipe.batch_size}${brew.recipe.batch_size_units}
          </py:if>
          | ${brew.recipe.get_type_display()}
          <py:if test="brew.recipe.style">
              | ${brew.recipe.style.name}
          </py:if>

          <py:if test="recipe_deriv">
              <py:if test="not recipe_deriv.can_not_derive_og()">
                  | <strong>${"%0.3f" % recipe_deriv.compute_og().average}</strong>
              </py:if>
              <py:if test="not recipe_deriv.can_not_derive_ibu()">
                  | <strong>${"%d" % recipe_deriv.compute_ibu().average}</strong> IBU
              </py:if>
              <py:if test="not recipe_deriv.can_not_derive_srm()">
                  | <strong>${"%d" % recipe_deriv.compute_srm().average}</strong> SRM
              </py:if>
          </py:if>
      </div>

      <div py:if="brew.notes and len(brew.notes) > 0">
          <h2>notes</h2>
          <div class="notes"><pre class="notes">${brew.notes}</pre></div>
      </div>

      <br/><a py:if="std.auth_user_is_user(request, user)" href="#" id="first-focused" onClick="$('#details').children().slideToggle(); return false;">edit brew details &uarr;</a>
      <div py:if="std.auth_user_is_user(request, user)" style="display:none">
          <h2>edit</h2>
          <form method="post" id="details-form" action="/user/${brew.brewer.username}/brew/${brew.id}/edit/">
              <table class="form" py:content="std.Markup(brew_form.as_table())"/>
              <input type="submit" value="update"/>
              <button onClick="$('#details').children().slideToggle(); $('#details-form').get()[0].reset(); return false;">cancel</button>
          </form>
      </div>
  </div>

  <h2>journal</h2>

  <?python
    now_steps = [step for step in steps if not step.in_future()]
    future_steps = [step for step in steps if step.in_future()]
  ?>
  <py:def function="step_row(std,user,brew,step)">
      <td><a href="/user/${user.username}/brew/${brew.id}/step/${step.id}">${std.fmt.date.best(step.date, user)}</a></td>
      <td>${step.get_type_display()}</td>
      <td><py:if test="step.volume">${step.volume} ${step.volume_units}</py:if></td>
      <td><py:if test="step.temp">${step.temp} ${step.temp_units}</py:if></td>
      <td>${step.gravity}</td>
      <td>${step.notes}</td>
  </py:def>
  <table width="100%">
    <thead>
      <tr>
        <th>date</th>
        <th>step</th>
        <th>volume</th>
        <th>temp</th>
        <th>gravity (corrected)</th>
        <th>notes</th>
      </tr>
    </thead>
    <tbody>
      <tr py:if="not steps">
        <td colspan="1000"><em>no steps recorded, yet.</em></td>
      </tr>
      <tr py:for="step in now_steps">${step_row(std,user,brew,step)}</tr>
    </tbody>
    <tbody py:if="future_steps" class="future">
        <tr py:for="step in future_steps">${step_row(std,user,brew,step)}</tr>
    </tbody>
  </table>

  <br />

  <div py:if="step_form and std.auth_user_is_user(request, user)" id="add-step">
    <div py:attrs="{'style': 'display:' + ['inherit', 'none'][step_edit]}">
      <a href="#" onClick="$('#add-step').children().slideToggle(); $('#add-step-form :input:first').focus(); return false;">update step &darr;</a>
    </div>
    <div py:attrs="{'style': 'display:' + ['inherit', 'none'][not step_edit]}">
        <form method="post" id="add-step-form">
            <table class="form">
                ${std.Markup(step_form.as_table())}
            </table>
            <input type="submit" value="update step"/>
            <button onClick="$('#add-step').children().slideToggle(); $('#add-step-form').get()[0].reset(); return false;">Cancel</button>
        </form>
    </div>
  </div>
  <br/>
  <div py:if="mash_sparge_calc_form" id="mash-sparge-calc-panel"
       py:with="expand=(mash_sparge_calc_form.is_bound and not mash_sparge_calc_form.is_valid())
                or request.GET.has_key('mash_sparge_recalc')
                ; calc=mash_sparge_calc_form.calc">
      <div py:attrs="{'style': 'display:' + ['none','inherit'][not expand]}">
          <a href="#" onClick="$('#mash-sparge-calc-panel').children().slideToggle(); return false;">compute mash/sparge volumes, steps &darr;</a>
      </div>
      <div py:attrs="{'style': 'display:' + ['none','inherit'][expand]}">
          <form method="GET" id="mash-sparge-calc">
              <input type="hidden" name="mash_sparge_recalc" />
              <table width="50%">

                  ${std.Markup(mash_sparge_calc_form.as_table())}

                  <tr>
                      <th>Mash Volume (gl)</th>
                      <td>${'%0.2f' % (calc.mash_volume)}</td>
                  </tr>
                  <tr>
                      <th>Strike Temp (Â°F)</th>
                      <td>${'%0.1f' % (calc.strike_temp)}</td>
                  </tr>
                  <tr>
                      <th>Sparge Volume (gl)</th>
                      <td>${'%0.2f' % (calc.sparge_volume)}</td>
                  </tr>
                  <tr>
                      <th>Total Volume (gl)</th>
                      <td>${'%0.2f' % (calc.total_volume)}</td>
                  </tr>
                  <tr>
                      <th>Total Collected/Pre-Boil volume (gl)</th>
                      <td>${'%0.2f' % (calc.collected_volume)}</td>
                  </tr>

                  <tr>
                      <th>actions</th>
                      <td>
                          <input type="submit" name="action" value="recalc"/>
                          <input type="reset" value="cancel" onClick="window.location.search = '';"/>
                          <input type="submit" name="action" value="create steps" onClick="$$('FORM#mash-sparge-calc').attr('method', 'POST'); return true;"/>
                      </td>
                  </tr>
              </table>
          </form><br />
          <div py:if="mash_sparge_steps">
              The following steps would be created:
              <table width="100%">
                  <thead>
                      <tr>
                          <th>date</th>
                          <th>step</th>
                          <th>volume</th>
                          <th>temp</th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr py:for="step in mash_sparge_steps">
                          <td>${std.fmt.date.best(step.date, user)}</td>
                          <td>${step.get_type_display()}</td>
                          <td><py:if test="step.volume">${'%0.2f' % step.volume} ${step.volume_units}</py:if></td>
                          <td><py:if test="step.temp">${'%0.1f' % step.temp} ${step.temp_units}</py:if></td>
                      </tr>
                  </tbody>
              </table>
          </div>
      </div>
  </div>


<h1>derivations</h1>
<table>
  <tr>
    <th>efficiency</th>
    <td py:if="deriv.can_not_derive_efficiency()">
      <div id="why_not_efficiency">
          <div class="muted">
              can't yet compute. <a href="#" onClick="$('#why_not_efficiency').children().slideToggle(); return false;">(why not?)</a>
          </div>
          <div style="display:none">
              <py:for each="reason in deriv.can_not_derive_efficiency()">
                  ${reason}<br/>
              </py:for>
              <a class="muted" href="#" onClick="$('#why_not_efficiency').children().slideToggle(); return false;">(hide)</a><br />
          </div>
      </div>
    </td>
    <td py:if="not deriv.can_not_derive_efficiency()">
        ${'%0.2f' % deriv.efficiency()}%
    </td>
  </tr>
  <tr>
    <th>alcohol by volume</th>
    <td py:if="deriv.can_not_derive_abv()">
      <div id="why_not_abv">
          <div class="muted">
              can't yet compute. <a href="#" onClick="$('#why_not_abv').children().slideToggle(); return false;">(why not?)</a>
          </div>
          <div style="display:none">
              <py:for each="reason in deriv.can_not_derive_abv()">
                  ${reason}<br />
              </py:for>
              <a class="muted" href="#" onClick="$('#why_not_abv').children().slideToggle(); return false;">(hide)</a><br />
          </div>
      </div>
    </td>
    <td py:if="not deriv.can_not_derive_abv()">
        ${'%0.2f' % (deriv.alcohol_by_volume())}%
    </td>
  </tr>
  <tr>
      <th>apparent attenuation</th>
      <td py:if="deriv.can_not_derive_aa()">
          <div id="why_not_aa">
              <div class="muted">
                  can't yet compute.  <a href="#" onClick="('#why_not_aa').children().slideToggle(); return false;">(why not?)</a>
              </div>
              <div style="display:none">
                  <py:for each="reason in deriv.can_not_derive_aa()">
                      ${reason}<br />
                  </py:for>
                  <a class="muted" href="#" onClick="$('#why_not_aa').children().slideToggle(); return false;">(hide)</a><br />
              </div>
          </div>
      </td>
      <td py:if="not deriv.can_not_derive_aa()">
          ${'%0.2f' % (deriv.apparent_attenuation())}%
      </td>
  </tr>
</table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
